const measureWidth = (item) => {
    let reqItemWidth = 0;
    
    
    const screenWidth = $(window).width();
    const list = item.closest(".products-menu");
    const items = $(".products-menu__item")
    
    
    const titleBlocks = list.find(".products-menu__title");
    const titleWidth = titleBlocks.width();
    
    const isTablet = window.matchMedia('(max-width: 768px)').matches;
    const isPhone = window.matchMedia('(max-width: 480px)').matches;
    
    const textContainer = item.find(".products-menu__container");
    const paddingLeft = parseInt(textContainer.css('padding-left'));
    const paddingRight = parseInt(textContainer.css('padding-right'));
    
    const itemNumber = items.index(item) + 1;
    
    if (isPhone) {
        reqItemWidth = screenWidth - titleWidth;
        let left = titleWidth * (titleBlocks.length - itemNumber);
        item.css({ "left": left });
    }
    else if (isTablet) {
        reqItemWidth = screenWidth - titleWidth * titleBlocks.length;
    }
    else {
    
        reqItemWidth = ((screenWidth * 0.5) - titleWidth * titleBlocks.length) > 530
        ? 530
        : (screenWidth * 0.5) - titleWidth;
    }
    
    return {
        container: reqItemWidth,
        textContainer: reqItemWidth - paddingLeft - paddingRight,
    }
    }
    
    const closeEveryAccoItem = list => {
    const items = list.find(".products-menu__item");
    const content = list.find(".products-menu__content");
    
    items.css({ "left": 0 });
    
    items.removeClass('active');
    content.width(0);
    }
    
    const openAccoItem = (item) => {
    const content = item.find(".products-menu__content");
    const reqWidth = measureWidth(item);
    const textBlock = item.find(".products-menu__container")
    
    item.addClass('active')
    
    content.width(reqWidth.container);
    
    textBlock.width(reqWidth.textContainer);
    }
    
    $(".products-menu__title").on('click', (e) => {
    e.preventDefault();
    const target = $(e.currentTarget);
    const item = target.closest(".products-menu__item");
    const content = item.find(".products-menu__content");
    const container = content.find(".products-menu__container");
    const list = $(".products-menu");
    const isOpened = item.hasClass('active')
    
    if (isOpened) {
        closeEveryAccoItem(list);
    }
    else {
        closeEveryAccoItem(list);
        openAccoItem(item);
    }
    })
    
    $(".products-menu__close").on('click', (e) => {
    e.preventDefault();
    closeEveryAccoItem($(".products-menu"));
    })
const slider = $(".slider__list").bxSlider({
    pager: false,
    controls: false,
});

$(".arrow--left").click((e) => {
    e.preventDefault();
    slider.goToPrevSlide();
});

$(".arrow--right").click((e) => {
    e.preventDefault();
    slider.goToNextSlide();
});
const validateFilds = (form, fieldArray) => {

    fieldArray.forEach(field => {
        field.removeClass("input-error");
        if (field.val().trim() === "") {
            field.addClass("input-error");
        }
    });

    const errorFields = form.find(".input-error")

    return errorFields.length === 0;
}
$('.form').submit(e => {
    e.preventDefault();

    const form = $(e.currentTarget);
    const name = form.find("[name='name']");
    const phone = form.find("[name='phone']");
    const comment = form.find("[name='comment']");
    const to = form.find("[name='to']");

    const modal = $("#modal");
    const content = modal.find(".modal__content");

    modal.removeClass("error-modal");

    const isValid = validateFilds(form, [name, phone, comment, to]);

    if (isValid) {
        const request = $.ajax({
            url: "https://webdev-api.loftschool.com/sendmail",
            method: "post",
            data: {
                name: name.val(),
                phone: phone.val(),
                comment: comment.val(),
                to: to.val(),
            },
        });

        request.done((data) => {
            content.text(data.message)
            $('form').trigger('reset');
        });

        request.fail((data) => {
            const message = data.responseJSON.message;
            content.text(message);
            modal.addClass("error-modal");
        })

        request.always(() => {
            $.fancybox.open ({
                src: "#modal",
                type: "inline",
            });
        })
    }
});

$(".app-submit-modal").click((e) => {
    e.preventDefault();
    $.fancybox.close();
});

$('form input[type="text"], form input[type="password"], form textarea').val('');
const hamburger_btn = document.querySelector('#hamburger-menu__link');
const hamburger_menu = document.querySelector('.menu--fixed');

    hamburger_btn.addEventListener('click', function(e) {
    e.preventDefault();

    let className = hamburger_btn.getAttribute('class');

    if (className == 'hamburger-menu__link') {
        hamburger_menu.classList.add('menu--active');
        hamburger_btn.classList.add('hamburger-menu__link--active');

        let body = document.getElementsByTagName('body')[0];
        body.style.overflow = "hidden";}
        
    else  {
        hamburger_menu.classList.remove('menu--active');
        hamburger_btn.classList.remove('hamburger-menu__link--active');

        let body = document.getElementsByTagName('body')[0];
        body.style.overflow = "visible";}
});

$('.menu__link').on('click', () => {
    $('.menu--fixed').removeClass('menu--active');
    $('#hamburger-menu__link').removeClass('hamburger-menu__link--active');
    
    let body = document.getElementsByTagName('body')[0];
    body.style.overflow = "visible";
});
  let myMap;

const init = () => {
  myMap = new ymaps.Map("map", {
    center: [55.668858, 37.869488],
    zoom: 13,
    controls: []
  });

  const coords =  [
    [55.674183, 37.858218],
    [55.684438, 37.855377],
    [55.654310, 37.846526],
    [55.661432, 37.879501]
  ];

  const myCollection = new ymaps.GeoObjectCollection({}, {
    draggable: false,
    iconLayout: 'default#image',
    iconImageHref: "./img/icons/marker.svg",
    iconImageSize: [46, 57],
    iconImageOffset: [-35, -52]
  });

  coords.forEach(coord => {
    myCollection.add(new ymaps.Placemark(coord));
  });

  myMap.geoObjects.add(myCollection);

  myMap.behaviors.disable('scrollZoom');
}

ymaps.ready(init); 
const sections = $('section');
const display = $('.maincontent');
const sideMenu = $(".fixed-menu");
const menuItems = sideMenu.find(".fixed-menu__item");

const mobileDetect = new MobileDetect(window.navigator.userAgent);
const isMobile = mobileDetect.mobile();

let inScroll = false;

sections.first().addClass("active");

const contSectionPosition = (sectionEq) => {
    const position = sectionEq * -100;
    
    if (isNaN(position)) {
        console.error("Передано не ыерное значение в contSectionPosition");
        return 0;
    }

    return position;
};

const changeMenuThemeForSection = sectionEq => {
    const currentSection = sections.eq(sectionEq);
    const menuTheme = currentSection.attr("data-sidemenu-theme");
    const activeClass = "fixed-menu--shadowed";

    if (menuTheme === "black") {
        sideMenu.addClass(activeClass);
    } else {
        sideMenu.removeClass(activeClass);
    }
};

const resetActiveClassForItem = (items, itemEq, activeClass) => {
    items.eq(itemEq).addClass(activeClass).siblings().removeClass(activeClass);
}

const performTransition = (sectionEq) => {
    if (inScroll) return;

    const transitionOver = 1000;
    const mouseInertionOver = 300;

    inScroll = true;

    const position = contSectionPosition(sectionEq);

    changeMenuThemeForSection(sectionEq);
    
    display.css({
        transform: `translateY(${position}%)`,
    });

    resetActiveClassForItem(sections, sectionEq, "active");

    setTimeout(() => {
    inScroll = false;  
    resetActiveClassForItem(menuItems, sectionEq, "fixed-menu__item--active");
    }, transitionOver + mouseInertionOver);
};

const viewportScroller = () => {
    const activeSection = sections.filter(".active");
    const nextSection = activeSection.next();
    const prevSection = activeSection.prev();

    return {
        next() {
            if (nextSection.length) {
                performTransition(nextSection.index());
            }
        },
        prev() {
            if (prevSection.length) {
                performTransition(prevSection.index());
            }
        },
    };
};

$(window).on("wheel", (e) => {
    const deltaY = e.originalEvent.deltaY;
    const scroller = viewportScroller();

    if (deltaY > 0) {
        scroller.next(); 
    }

    if (deltaY < 0) {
        scroller.prev(); 
    }
});

$(window).on("keydown", (e) => {
    const tagName = e.target.tagName.toLowerCase();
    const userTypingInInputs = tagName === "input" || tagName === "textarea";
    const scroller = viewportScroller();

    if (userTypingInInputs) return;

    switch (e.keyCode) {
        case 38: //PREV
            scroller("prev"); 
            break;

        case 40: //NEXT
            scroller("next"); 
            break;
    }
});

$(".wrapper").on("touchmove", (e) => e.preventDefault());

$("[data-scroll-to]").click((e) => {
    e.preventDefault();

    const $this = $(e.currentTarget);
    const target = $this.attr("data-scroll-to");
    const reqSection = $(`[data-section-id=${target}]`);

    performTransition(reqSection.index());
});

if (isMobile) {
    $("body").swipe({
        swipe: function (event, direction) {
          const scroller = viewportScroller();
          let scrollDirection = "";
    
          if (direction == "up") scrollDirection = "next";
          if (direction == "down") scrollDirection = "prev";
    
          scroller[scrollDirection]();
        },
      });
};
const btnPlay = document.querySelector('.btn-play');
const videoPlayer = document.querySelector('.video__player');


// Плей-Пауза

const togglePlay = () => {
    if (videoPlayer.paused || videoPlayer.ended) {
        videoPlayer.play(); 
        $('.btn-play__icon').css('display', 'none');
        $('.btn-pause__icon').css('display', 'block');
    } else {
        videoPlayer.pause();
       $('.btn-play__icon').css('display', 'block');
        $('.btn-pause__icon').css('display', 'none');
    }
};

$(videoPlayer).on('click', togglePlay);
$(btnPlay).on('click', togglePlay);
$('.btn-play--big').on('click', togglePlay);

// Управление воспромзведением видео

  $(".video__cursor").on("click", e => {
    const bar = $(e.currentTarget);
    const clickedPosition = e.originalEvent.layerX;
    const newPlaybackPositionSec = videoPlayer.duration * clickedPosition / bar.width();

    videoPlayer.currentTime = newPlaybackPositionSec;
  });

  videoPlayer.ontimeupdate = function () {
    const durationSec = videoPlayer.duration;
    const completedSec = videoPlayer.currentTime;
    const completedPercent = (completedSec / durationSec) * 100;

    $(".video__cursor-btn").css({
      left: `${completedPercent}%`
    });
  };

// Управление громкостью звука

  $(".video__volume").on("click", e => {
    const bar = $(e.currentTarget);
    const clickedPosition = e.originalEvent.layerX;

    videoPlayer.volume = clickedPosition / bar.width();
  });

  videoPlayer.onvolumechange = () => {
    const currentVolume = videoPlayer.volume;
    const newButtonPositionPercent = currentVolume * 100;

    $(".video__volume-button").css({
      left: `${newButtonPositionPercent}%`
    });
  };

// Без звука 

  $('.btn-volume').on('click', function () {

    if (videoPlayer.volume > 0) {
        videoPlayer.volume = 0;
        $('.btn-volume__line').css('display', 'block');
    } else {
        videoPlayer.volume = 1;
       $('.btn-volume__line').css('display', 'none');
  }
});
const ctrlList = document.querySelector('.reviews__switcher');
const ctrlItems = document.querySelectorAll('.interactive-avatar');
const reviewItems = document.querySelectorAll('.reviews__display-inner');


[].forEach.call(ctrlItems, (el) => {
    el.addEventListener('click', (e) => {
        e.preventDefault();
        let ctrlItem = e.target.closest('li');

        for (let i = 0; i < ctrlItems.length; i++) {
            ctrlItems[i].classList.remove('interactive-avatar--active');
    
            if (ctrlItems[i] === ctrlItem) {
                reviewItems[i].classList.add('reviews__display-inner--active');
                
            } else {
                reviewItems[i].classList.remove('reviews__display-inner--active');
            }
        }
        ctrlItem.classList.add('interactive-avatar--active');

    })
});
const teamItems = document.querySelectorAll('.team__item');

[].forEach.call(teamItems, function(el) {
    el.addEventListener('click', function() {

        if (!el.classList.contains('team__item--active')) {
            for (let i = 0; i < teamItems.length; i++) {
                teamItems[i].classList.remove('team__item--active')
            }
            el.classList.add('team__item--active');
        } else {
            el.classList.remove('team__item--active');
        }
    });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjY29yZGVvbi5qcyIsImFycm93LmpzIiwiZm9ybS5qcyIsImhhbWJ1cmdlci5qcyIsIm1hcC5qcyIsIm9wcy5qcyIsInBsYXllci5qcyIsInJldmlld3MtY29udHJvbC5qcyIsInRlYW0tYWNjb3JkZW9uLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyRkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbEVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzdCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6SUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdkVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3ZCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoibWFpbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBtZWFzdXJlV2lkdGggPSAoaXRlbSkgPT4ge1xyXG4gICAgbGV0IHJlcUl0ZW1XaWR0aCA9IDA7XHJcbiAgICBcclxuICAgIFxyXG4gICAgY29uc3Qgc2NyZWVuV2lkdGggPSAkKHdpbmRvdykud2lkdGgoKTtcclxuICAgIGNvbnN0IGxpc3QgPSBpdGVtLmNsb3Nlc3QoXCIucHJvZHVjdHMtbWVudVwiKTtcclxuICAgIGNvbnN0IGl0ZW1zID0gJChcIi5wcm9kdWN0cy1tZW51X19pdGVtXCIpXHJcbiAgICBcclxuICAgIFxyXG4gICAgY29uc3QgdGl0bGVCbG9ja3MgPSBsaXN0LmZpbmQoXCIucHJvZHVjdHMtbWVudV9fdGl0bGVcIik7XHJcbiAgICBjb25zdCB0aXRsZVdpZHRoID0gdGl0bGVCbG9ja3Mud2lkdGgoKTtcclxuICAgIFxyXG4gICAgY29uc3QgaXNUYWJsZXQgPSB3aW5kb3cubWF0Y2hNZWRpYSgnKG1heC13aWR0aDogNzY4cHgpJykubWF0Y2hlcztcclxuICAgIGNvbnN0IGlzUGhvbmUgPSB3aW5kb3cubWF0Y2hNZWRpYSgnKG1heC13aWR0aDogNDgwcHgpJykubWF0Y2hlcztcclxuICAgIFxyXG4gICAgY29uc3QgdGV4dENvbnRhaW5lciA9IGl0ZW0uZmluZChcIi5wcm9kdWN0cy1tZW51X19jb250YWluZXJcIik7XHJcbiAgICBjb25zdCBwYWRkaW5nTGVmdCA9IHBhcnNlSW50KHRleHRDb250YWluZXIuY3NzKCdwYWRkaW5nLWxlZnQnKSk7XHJcbiAgICBjb25zdCBwYWRkaW5nUmlnaHQgPSBwYXJzZUludCh0ZXh0Q29udGFpbmVyLmNzcygncGFkZGluZy1yaWdodCcpKTtcclxuICAgIFxyXG4gICAgY29uc3QgaXRlbU51bWJlciA9IGl0ZW1zLmluZGV4KGl0ZW0pICsgMTtcclxuICAgIFxyXG4gICAgaWYgKGlzUGhvbmUpIHtcclxuICAgICAgICByZXFJdGVtV2lkdGggPSBzY3JlZW5XaWR0aCAtIHRpdGxlV2lkdGg7XHJcbiAgICAgICAgbGV0IGxlZnQgPSB0aXRsZVdpZHRoICogKHRpdGxlQmxvY2tzLmxlbmd0aCAtIGl0ZW1OdW1iZXIpO1xyXG4gICAgICAgIGl0ZW0uY3NzKHsgXCJsZWZ0XCI6IGxlZnQgfSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmIChpc1RhYmxldCkge1xyXG4gICAgICAgIHJlcUl0ZW1XaWR0aCA9IHNjcmVlbldpZHRoIC0gdGl0bGVXaWR0aCAqIHRpdGxlQmxvY2tzLmxlbmd0aDtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgXHJcbiAgICAgICAgcmVxSXRlbVdpZHRoID0gKChzY3JlZW5XaWR0aCAqIDAuNSkgLSB0aXRsZVdpZHRoICogdGl0bGVCbG9ja3MubGVuZ3RoKSA+IDUzMFxyXG4gICAgICAgID8gNTMwXHJcbiAgICAgICAgOiAoc2NyZWVuV2lkdGggKiAwLjUpIC0gdGl0bGVXaWR0aDtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBjb250YWluZXI6IHJlcUl0ZW1XaWR0aCxcclxuICAgICAgICB0ZXh0Q29udGFpbmVyOiByZXFJdGVtV2lkdGggLSBwYWRkaW5nTGVmdCAtIHBhZGRpbmdSaWdodCxcclxuICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgY29uc3QgY2xvc2VFdmVyeUFjY29JdGVtID0gbGlzdCA9PiB7XHJcbiAgICBjb25zdCBpdGVtcyA9IGxpc3QuZmluZChcIi5wcm9kdWN0cy1tZW51X19pdGVtXCIpO1xyXG4gICAgY29uc3QgY29udGVudCA9IGxpc3QuZmluZChcIi5wcm9kdWN0cy1tZW51X19jb250ZW50XCIpO1xyXG4gICAgXHJcbiAgICBpdGVtcy5jc3MoeyBcImxlZnRcIjogMCB9KTtcclxuICAgIFxyXG4gICAgaXRlbXMucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xyXG4gICAgY29udGVudC53aWR0aCgwKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgY29uc3Qgb3BlbkFjY29JdGVtID0gKGl0ZW0pID0+IHtcclxuICAgIGNvbnN0IGNvbnRlbnQgPSBpdGVtLmZpbmQoXCIucHJvZHVjdHMtbWVudV9fY29udGVudFwiKTtcclxuICAgIGNvbnN0IHJlcVdpZHRoID0gbWVhc3VyZVdpZHRoKGl0ZW0pO1xyXG4gICAgY29uc3QgdGV4dEJsb2NrID0gaXRlbS5maW5kKFwiLnByb2R1Y3RzLW1lbnVfX2NvbnRhaW5lclwiKVxyXG4gICAgXHJcbiAgICBpdGVtLmFkZENsYXNzKCdhY3RpdmUnKVxyXG4gICAgXHJcbiAgICBjb250ZW50LndpZHRoKHJlcVdpZHRoLmNvbnRhaW5lcik7XHJcbiAgICBcclxuICAgIHRleHRCbG9jay53aWR0aChyZXFXaWR0aC50ZXh0Q29udGFpbmVyKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgJChcIi5wcm9kdWN0cy1tZW51X190aXRsZVwiKS5vbignY2xpY2snLCAoZSkgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgY29uc3QgdGFyZ2V0ID0gJChlLmN1cnJlbnRUYXJnZXQpO1xyXG4gICAgY29uc3QgaXRlbSA9IHRhcmdldC5jbG9zZXN0KFwiLnByb2R1Y3RzLW1lbnVfX2l0ZW1cIik7XHJcbiAgICBjb25zdCBjb250ZW50ID0gaXRlbS5maW5kKFwiLnByb2R1Y3RzLW1lbnVfX2NvbnRlbnRcIik7XHJcbiAgICBjb25zdCBjb250YWluZXIgPSBjb250ZW50LmZpbmQoXCIucHJvZHVjdHMtbWVudV9fY29udGFpbmVyXCIpO1xyXG4gICAgY29uc3QgbGlzdCA9ICQoXCIucHJvZHVjdHMtbWVudVwiKTtcclxuICAgIGNvbnN0IGlzT3BlbmVkID0gaXRlbS5oYXNDbGFzcygnYWN0aXZlJylcclxuICAgIFxyXG4gICAgaWYgKGlzT3BlbmVkKSB7XHJcbiAgICAgICAgY2xvc2VFdmVyeUFjY29JdGVtKGxpc3QpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgY2xvc2VFdmVyeUFjY29JdGVtKGxpc3QpO1xyXG4gICAgICAgIG9wZW5BY2NvSXRlbShpdGVtKTtcclxuICAgIH1cclxuICAgIH0pXHJcbiAgICBcclxuICAgICQoXCIucHJvZHVjdHMtbWVudV9fY2xvc2VcIikub24oJ2NsaWNrJywgKGUpID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIGNsb3NlRXZlcnlBY2NvSXRlbSgkKFwiLnByb2R1Y3RzLW1lbnVcIikpO1xyXG4gICAgfSkiLCJjb25zdCBzbGlkZXIgPSAkKFwiLnNsaWRlcl9fbGlzdFwiKS5ieFNsaWRlcih7XHJcbiAgICBwYWdlcjogZmFsc2UsXHJcbiAgICBjb250cm9sczogZmFsc2UsXHJcbn0pO1xyXG5cclxuJChcIi5hcnJvdy0tbGVmdFwiKS5jbGljaygoZSkgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgc2xpZGVyLmdvVG9QcmV2U2xpZGUoKTtcclxufSk7XHJcblxyXG4kKFwiLmFycm93LS1yaWdodFwiKS5jbGljaygoZSkgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgc2xpZGVyLmdvVG9OZXh0U2xpZGUoKTtcclxufSk7IiwiY29uc3QgdmFsaWRhdGVGaWxkcyA9IChmb3JtLCBmaWVsZEFycmF5KSA9PiB7XHJcblxyXG4gICAgZmllbGRBcnJheS5mb3JFYWNoKGZpZWxkID0+IHtcclxuICAgICAgICBmaWVsZC5yZW1vdmVDbGFzcyhcImlucHV0LWVycm9yXCIpO1xyXG4gICAgICAgIGlmIChmaWVsZC52YWwoKS50cmltKCkgPT09IFwiXCIpIHtcclxuICAgICAgICAgICAgZmllbGQuYWRkQ2xhc3MoXCJpbnB1dC1lcnJvclwiKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCBlcnJvckZpZWxkcyA9IGZvcm0uZmluZChcIi5pbnB1dC1lcnJvclwiKVxyXG5cclxuICAgIHJldHVybiBlcnJvckZpZWxkcy5sZW5ndGggPT09IDA7XHJcbn1cclxuJCgnLmZvcm0nKS5zdWJtaXQoZSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcblxyXG4gICAgY29uc3QgZm9ybSA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcclxuICAgIGNvbnN0IG5hbWUgPSBmb3JtLmZpbmQoXCJbbmFtZT0nbmFtZSddXCIpO1xyXG4gICAgY29uc3QgcGhvbmUgPSBmb3JtLmZpbmQoXCJbbmFtZT0ncGhvbmUnXVwiKTtcclxuICAgIGNvbnN0IGNvbW1lbnQgPSBmb3JtLmZpbmQoXCJbbmFtZT0nY29tbWVudCddXCIpO1xyXG4gICAgY29uc3QgdG8gPSBmb3JtLmZpbmQoXCJbbmFtZT0ndG8nXVwiKTtcclxuXHJcbiAgICBjb25zdCBtb2RhbCA9ICQoXCIjbW9kYWxcIik7XHJcbiAgICBjb25zdCBjb250ZW50ID0gbW9kYWwuZmluZChcIi5tb2RhbF9fY29udGVudFwiKTtcclxuXHJcbiAgICBtb2RhbC5yZW1vdmVDbGFzcyhcImVycm9yLW1vZGFsXCIpO1xyXG5cclxuICAgIGNvbnN0IGlzVmFsaWQgPSB2YWxpZGF0ZUZpbGRzKGZvcm0sIFtuYW1lLCBwaG9uZSwgY29tbWVudCwgdG9dKTtcclxuXHJcbiAgICBpZiAoaXNWYWxpZCkge1xyXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSAkLmFqYXgoe1xyXG4gICAgICAgICAgICB1cmw6IFwiaHR0cHM6Ly93ZWJkZXYtYXBpLmxvZnRzY2hvb2wuY29tL3NlbmRtYWlsXCIsXHJcbiAgICAgICAgICAgIG1ldGhvZDogXCJwb3N0XCIsXHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUudmFsKCksXHJcbiAgICAgICAgICAgICAgICBwaG9uZTogcGhvbmUudmFsKCksXHJcbiAgICAgICAgICAgICAgICBjb21tZW50OiBjb21tZW50LnZhbCgpLFxyXG4gICAgICAgICAgICAgICAgdG86IHRvLnZhbCgpLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXF1ZXN0LmRvbmUoKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgY29udGVudC50ZXh0KGRhdGEubWVzc2FnZSlcclxuICAgICAgICAgICAgJCgnZm9ybScpLnRyaWdnZXIoJ3Jlc2V0Jyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcXVlc3QuZmFpbCgoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gZGF0YS5yZXNwb25zZUpTT04ubWVzc2FnZTtcclxuICAgICAgICAgICAgY29udGVudC50ZXh0KG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICBtb2RhbC5hZGRDbGFzcyhcImVycm9yLW1vZGFsXCIpO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIHJlcXVlc3QuYWx3YXlzKCgpID0+IHtcclxuICAgICAgICAgICAgJC5mYW5jeWJveC5vcGVuICh7XHJcbiAgICAgICAgICAgICAgICBzcmM6IFwiI21vZGFsXCIsXHJcbiAgICAgICAgICAgICAgICB0eXBlOiBcImlubGluZVwiLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG59KTtcclxuXHJcbiQoXCIuYXBwLXN1Ym1pdC1tb2RhbFwiKS5jbGljaygoZSkgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgJC5mYW5jeWJveC5jbG9zZSgpO1xyXG59KTtcclxuXHJcbiQoJ2Zvcm0gaW5wdXRbdHlwZT1cInRleHRcIl0sIGZvcm0gaW5wdXRbdHlwZT1cInBhc3N3b3JkXCJdLCBmb3JtIHRleHRhcmVhJykudmFsKCcnKTsiLCJjb25zdCBoYW1idXJnZXJfYnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2hhbWJ1cmdlci1tZW51X19saW5rJyk7XHJcbmNvbnN0IGhhbWJ1cmdlcl9tZW51ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm1lbnUtLWZpeGVkJyk7XHJcblxyXG4gICAgaGFtYnVyZ2VyX2J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKGUpIHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuXHJcbiAgICBsZXQgY2xhc3NOYW1lID0gaGFtYnVyZ2VyX2J0bi5nZXRBdHRyaWJ1dGUoJ2NsYXNzJyk7XHJcblxyXG4gICAgaWYgKGNsYXNzTmFtZSA9PSAnaGFtYnVyZ2VyLW1lbnVfX2xpbmsnKSB7XHJcbiAgICAgICAgaGFtYnVyZ2VyX21lbnUuY2xhc3NMaXN0LmFkZCgnbWVudS0tYWN0aXZlJyk7XHJcbiAgICAgICAgaGFtYnVyZ2VyX2J0bi5jbGFzc0xpc3QuYWRkKCdoYW1idXJnZXItbWVudV9fbGluay0tYWN0aXZlJyk7XHJcblxyXG4gICAgICAgIGxldCBib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXTtcclxuICAgICAgICBib2R5LnN0eWxlLm92ZXJmbG93ID0gXCJoaWRkZW5cIjt9XHJcbiAgICAgICAgXHJcbiAgICBlbHNlICB7XHJcbiAgICAgICAgaGFtYnVyZ2VyX21lbnUuY2xhc3NMaXN0LnJlbW92ZSgnbWVudS0tYWN0aXZlJyk7XHJcbiAgICAgICAgaGFtYnVyZ2VyX2J0bi5jbGFzc0xpc3QucmVtb3ZlKCdoYW1idXJnZXItbWVudV9fbGluay0tYWN0aXZlJyk7XHJcblxyXG4gICAgICAgIGxldCBib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXTtcclxuICAgICAgICBib2R5LnN0eWxlLm92ZXJmbG93ID0gXCJ2aXNpYmxlXCI7fVxyXG59KTtcclxuXHJcbiQoJy5tZW51X19saW5rJykub24oJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgJCgnLm1lbnUtLWZpeGVkJykucmVtb3ZlQ2xhc3MoJ21lbnUtLWFjdGl2ZScpO1xyXG4gICAgJCgnI2hhbWJ1cmdlci1tZW51X19saW5rJykucmVtb3ZlQ2xhc3MoJ2hhbWJ1cmdlci1tZW51X19saW5rLS1hY3RpdmUnKTtcclxuICAgIFxyXG4gICAgbGV0IGJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdO1xyXG4gICAgYm9keS5zdHlsZS5vdmVyZmxvdyA9IFwidmlzaWJsZVwiO1xyXG59KTsiLCIgIGxldCBteU1hcDtcclxuXHJcbmNvbnN0IGluaXQgPSAoKSA9PiB7XHJcbiAgbXlNYXAgPSBuZXcgeW1hcHMuTWFwKFwibWFwXCIsIHtcclxuICAgIGNlbnRlcjogWzU1LjY2ODg1OCwgMzcuODY5NDg4XSxcclxuICAgIHpvb206IDEzLFxyXG4gICAgY29udHJvbHM6IFtdXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IGNvb3JkcyA9ICBbXHJcbiAgICBbNTUuNjc0MTgzLCAzNy44NTgyMThdLFxyXG4gICAgWzU1LjY4NDQzOCwgMzcuODU1Mzc3XSxcclxuICAgIFs1NS42NTQzMTAsIDM3Ljg0NjUyNl0sXHJcbiAgICBbNTUuNjYxNDMyLCAzNy44Nzk1MDFdXHJcbiAgXTtcclxuXHJcbiAgY29uc3QgbXlDb2xsZWN0aW9uID0gbmV3IHltYXBzLkdlb09iamVjdENvbGxlY3Rpb24oe30sIHtcclxuICAgIGRyYWdnYWJsZTogZmFsc2UsXHJcbiAgICBpY29uTGF5b3V0OiAnZGVmYXVsdCNpbWFnZScsXHJcbiAgICBpY29uSW1hZ2VIcmVmOiBcIi4vaW1nL2ljb25zL21hcmtlci5zdmdcIixcclxuICAgIGljb25JbWFnZVNpemU6IFs0NiwgNTddLFxyXG4gICAgaWNvbkltYWdlT2Zmc2V0OiBbLTM1LCAtNTJdXHJcbiAgfSk7XHJcblxyXG4gIGNvb3Jkcy5mb3JFYWNoKGNvb3JkID0+IHtcclxuICAgIG15Q29sbGVjdGlvbi5hZGQobmV3IHltYXBzLlBsYWNlbWFyayhjb29yZCkpO1xyXG4gIH0pO1xyXG5cclxuICBteU1hcC5nZW9PYmplY3RzLmFkZChteUNvbGxlY3Rpb24pO1xyXG5cclxuICBteU1hcC5iZWhhdmlvcnMuZGlzYWJsZSgnc2Nyb2xsWm9vbScpO1xyXG59XHJcblxyXG55bWFwcy5yZWFkeShpbml0KTsgIiwiY29uc3Qgc2VjdGlvbnMgPSAkKCdzZWN0aW9uJyk7XHJcbmNvbnN0IGRpc3BsYXkgPSAkKCcubWFpbmNvbnRlbnQnKTtcclxuY29uc3Qgc2lkZU1lbnUgPSAkKFwiLmZpeGVkLW1lbnVcIik7XHJcbmNvbnN0IG1lbnVJdGVtcyA9IHNpZGVNZW51LmZpbmQoXCIuZml4ZWQtbWVudV9faXRlbVwiKTtcclxuXHJcbmNvbnN0IG1vYmlsZURldGVjdCA9IG5ldyBNb2JpbGVEZXRlY3Qod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpO1xyXG5jb25zdCBpc01vYmlsZSA9IG1vYmlsZURldGVjdC5tb2JpbGUoKTtcclxuXHJcbmxldCBpblNjcm9sbCA9IGZhbHNlO1xyXG5cclxuc2VjdGlvbnMuZmlyc3QoKS5hZGRDbGFzcyhcImFjdGl2ZVwiKTtcclxuXHJcbmNvbnN0IGNvbnRTZWN0aW9uUG9zaXRpb24gPSAoc2VjdGlvbkVxKSA9PiB7XHJcbiAgICBjb25zdCBwb3NpdGlvbiA9IHNlY3Rpb25FcSAqIC0xMDA7XHJcbiAgICBcclxuICAgIGlmIChpc05hTihwb3NpdGlvbikpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKFwi0J/QtdGA0LXQtNCw0L3QviDQvdC1INGL0LXRgNC90L7QtSDQt9C90LDRh9C10L3QuNC1INCyIGNvbnRTZWN0aW9uUG9zaXRpb25cIik7XHJcbiAgICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHBvc2l0aW9uO1xyXG59O1xyXG5cclxuY29uc3QgY2hhbmdlTWVudVRoZW1lRm9yU2VjdGlvbiA9IHNlY3Rpb25FcSA9PiB7XHJcbiAgICBjb25zdCBjdXJyZW50U2VjdGlvbiA9IHNlY3Rpb25zLmVxKHNlY3Rpb25FcSk7XHJcbiAgICBjb25zdCBtZW51VGhlbWUgPSBjdXJyZW50U2VjdGlvbi5hdHRyKFwiZGF0YS1zaWRlbWVudS10aGVtZVwiKTtcclxuICAgIGNvbnN0IGFjdGl2ZUNsYXNzID0gXCJmaXhlZC1tZW51LS1zaGFkb3dlZFwiO1xyXG5cclxuICAgIGlmIChtZW51VGhlbWUgPT09IFwiYmxhY2tcIikge1xyXG4gICAgICAgIHNpZGVNZW51LmFkZENsYXNzKGFjdGl2ZUNsYXNzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgc2lkZU1lbnUucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3MpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuY29uc3QgcmVzZXRBY3RpdmVDbGFzc0Zvckl0ZW0gPSAoaXRlbXMsIGl0ZW1FcSwgYWN0aXZlQ2xhc3MpID0+IHtcclxuICAgIGl0ZW1zLmVxKGl0ZW1FcSkuYWRkQ2xhc3MoYWN0aXZlQ2xhc3MpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3MpO1xyXG59XHJcblxyXG5jb25zdCBwZXJmb3JtVHJhbnNpdGlvbiA9IChzZWN0aW9uRXEpID0+IHtcclxuICAgIGlmIChpblNjcm9sbCkgcmV0dXJuO1xyXG5cclxuICAgIGNvbnN0IHRyYW5zaXRpb25PdmVyID0gMTAwMDtcclxuICAgIGNvbnN0IG1vdXNlSW5lcnRpb25PdmVyID0gMzAwO1xyXG5cclxuICAgIGluU2Nyb2xsID0gdHJ1ZTtcclxuXHJcbiAgICBjb25zdCBwb3NpdGlvbiA9IGNvbnRTZWN0aW9uUG9zaXRpb24oc2VjdGlvbkVxKTtcclxuXHJcbiAgICBjaGFuZ2VNZW51VGhlbWVGb3JTZWN0aW9uKHNlY3Rpb25FcSk7XHJcbiAgICBcclxuICAgIGRpc3BsYXkuY3NzKHtcclxuICAgICAgICB0cmFuc2Zvcm06IGB0cmFuc2xhdGVZKCR7cG9zaXRpb259JSlgLFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmVzZXRBY3RpdmVDbGFzc0Zvckl0ZW0oc2VjdGlvbnMsIHNlY3Rpb25FcSwgXCJhY3RpdmVcIik7XHJcblxyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICBpblNjcm9sbCA9IGZhbHNlOyAgXHJcbiAgICByZXNldEFjdGl2ZUNsYXNzRm9ySXRlbShtZW51SXRlbXMsIHNlY3Rpb25FcSwgXCJmaXhlZC1tZW51X19pdGVtLS1hY3RpdmVcIik7XHJcbiAgICB9LCB0cmFuc2l0aW9uT3ZlciArIG1vdXNlSW5lcnRpb25PdmVyKTtcclxufTtcclxuXHJcbmNvbnN0IHZpZXdwb3J0U2Nyb2xsZXIgPSAoKSA9PiB7XHJcbiAgICBjb25zdCBhY3RpdmVTZWN0aW9uID0gc2VjdGlvbnMuZmlsdGVyKFwiLmFjdGl2ZVwiKTtcclxuICAgIGNvbnN0IG5leHRTZWN0aW9uID0gYWN0aXZlU2VjdGlvbi5uZXh0KCk7XHJcbiAgICBjb25zdCBwcmV2U2VjdGlvbiA9IGFjdGl2ZVNlY3Rpb24ucHJldigpO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgbmV4dCgpIHtcclxuICAgICAgICAgICAgaWYgKG5leHRTZWN0aW9uLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcGVyZm9ybVRyYW5zaXRpb24obmV4dFNlY3Rpb24uaW5kZXgoKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHByZXYoKSB7XHJcbiAgICAgICAgICAgIGlmIChwcmV2U2VjdGlvbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHBlcmZvcm1UcmFuc2l0aW9uKHByZXZTZWN0aW9uLmluZGV4KCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgIH07XHJcbn07XHJcblxyXG4kKHdpbmRvdykub24oXCJ3aGVlbFwiLCAoZSkgPT4ge1xyXG4gICAgY29uc3QgZGVsdGFZID0gZS5vcmlnaW5hbEV2ZW50LmRlbHRhWTtcclxuICAgIGNvbnN0IHNjcm9sbGVyID0gdmlld3BvcnRTY3JvbGxlcigpO1xyXG5cclxuICAgIGlmIChkZWx0YVkgPiAwKSB7XHJcbiAgICAgICAgc2Nyb2xsZXIubmV4dCgpOyBcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZGVsdGFZIDwgMCkge1xyXG4gICAgICAgIHNjcm9sbGVyLnByZXYoKTsgXHJcbiAgICB9XHJcbn0pO1xyXG5cclxuJCh3aW5kb3cpLm9uKFwia2V5ZG93blwiLCAoZSkgPT4ge1xyXG4gICAgY29uc3QgdGFnTmFtZSA9IGUudGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgIGNvbnN0IHVzZXJUeXBpbmdJbklucHV0cyA9IHRhZ05hbWUgPT09IFwiaW5wdXRcIiB8fCB0YWdOYW1lID09PSBcInRleHRhcmVhXCI7XHJcbiAgICBjb25zdCBzY3JvbGxlciA9IHZpZXdwb3J0U2Nyb2xsZXIoKTtcclxuXHJcbiAgICBpZiAodXNlclR5cGluZ0luSW5wdXRzKSByZXR1cm47XHJcblxyXG4gICAgc3dpdGNoIChlLmtleUNvZGUpIHtcclxuICAgICAgICBjYXNlIDM4OiAvL1BSRVZcclxuICAgICAgICAgICAgc2Nyb2xsZXIoXCJwcmV2XCIpOyBcclxuICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgIGNhc2UgNDA6IC8vTkVYVFxyXG4gICAgICAgICAgICBzY3JvbGxlcihcIm5leHRcIik7IFxyXG4gICAgICAgICAgICBicmVhaztcclxuICAgIH1cclxufSk7XHJcblxyXG4kKFwiLndyYXBwZXJcIikub24oXCJ0b3VjaG1vdmVcIiwgKGUpID0+IGUucHJldmVudERlZmF1bHQoKSk7XHJcblxyXG4kKFwiW2RhdGEtc2Nyb2xsLXRvXVwiKS5jbGljaygoZSkgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cclxuICAgIGNvbnN0ICR0aGlzID0gJChlLmN1cnJlbnRUYXJnZXQpO1xyXG4gICAgY29uc3QgdGFyZ2V0ID0gJHRoaXMuYXR0cihcImRhdGEtc2Nyb2xsLXRvXCIpO1xyXG4gICAgY29uc3QgcmVxU2VjdGlvbiA9ICQoYFtkYXRhLXNlY3Rpb24taWQ9JHt0YXJnZXR9XWApO1xyXG5cclxuICAgIHBlcmZvcm1UcmFuc2l0aW9uKHJlcVNlY3Rpb24uaW5kZXgoKSk7XHJcbn0pO1xyXG5cclxuaWYgKGlzTW9iaWxlKSB7XHJcbiAgICAkKFwiYm9keVwiKS5zd2lwZSh7XHJcbiAgICAgICAgc3dpcGU6IGZ1bmN0aW9uIChldmVudCwgZGlyZWN0aW9uKSB7XHJcbiAgICAgICAgICBjb25zdCBzY3JvbGxlciA9IHZpZXdwb3J0U2Nyb2xsZXIoKTtcclxuICAgICAgICAgIGxldCBzY3JvbGxEaXJlY3Rpb24gPSBcIlwiO1xyXG4gICAgXHJcbiAgICAgICAgICBpZiAoZGlyZWN0aW9uID09IFwidXBcIikgc2Nyb2xsRGlyZWN0aW9uID0gXCJuZXh0XCI7XHJcbiAgICAgICAgICBpZiAoZGlyZWN0aW9uID09IFwiZG93blwiKSBzY3JvbGxEaXJlY3Rpb24gPSBcInByZXZcIjtcclxuICAgIFxyXG4gICAgICAgICAgc2Nyb2xsZXJbc2Nyb2xsRGlyZWN0aW9uXSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pO1xyXG59OyIsImNvbnN0IGJ0blBsYXkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuYnRuLXBsYXknKTtcclxuY29uc3QgdmlkZW9QbGF5ZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudmlkZW9fX3BsYXllcicpO1xyXG5cclxuXHJcbi8vINCf0LvQtdC5LdCf0LDRg9C30LBcclxuXHJcbmNvbnN0IHRvZ2dsZVBsYXkgPSAoKSA9PiB7XHJcbiAgICBpZiAodmlkZW9QbGF5ZXIucGF1c2VkIHx8IHZpZGVvUGxheWVyLmVuZGVkKSB7XHJcbiAgICAgICAgdmlkZW9QbGF5ZXIucGxheSgpOyBcclxuICAgICAgICAkKCcuYnRuLXBsYXlfX2ljb24nKS5jc3MoJ2Rpc3BsYXknLCAnbm9uZScpO1xyXG4gICAgICAgICQoJy5idG4tcGF1c2VfX2ljb24nKS5jc3MoJ2Rpc3BsYXknLCAnYmxvY2snKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdmlkZW9QbGF5ZXIucGF1c2UoKTtcclxuICAgICAgICQoJy5idG4tcGxheV9faWNvbicpLmNzcygnZGlzcGxheScsICdibG9jaycpO1xyXG4gICAgICAgICQoJy5idG4tcGF1c2VfX2ljb24nKS5jc3MoJ2Rpc3BsYXknLCAnbm9uZScpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuJCh2aWRlb1BsYXllcikub24oJ2NsaWNrJywgdG9nZ2xlUGxheSk7XHJcbiQoYnRuUGxheSkub24oJ2NsaWNrJywgdG9nZ2xlUGxheSk7XHJcbiQoJy5idG4tcGxheS0tYmlnJykub24oJ2NsaWNrJywgdG9nZ2xlUGxheSk7XHJcblxyXG4vLyDQo9C/0YDQsNCy0LvQtdC90LjQtSDQstC+0YHQv9GA0L7QvNC30LLQtdC00LXQvdC40LXQvCDQstC40LTQtdC+XHJcblxyXG4gICQoXCIudmlkZW9fX2N1cnNvclwiKS5vbihcImNsaWNrXCIsIGUgPT4ge1xyXG4gICAgY29uc3QgYmFyID0gJChlLmN1cnJlbnRUYXJnZXQpO1xyXG4gICAgY29uc3QgY2xpY2tlZFBvc2l0aW9uID0gZS5vcmlnaW5hbEV2ZW50LmxheWVyWDtcclxuICAgIGNvbnN0IG5ld1BsYXliYWNrUG9zaXRpb25TZWMgPSB2aWRlb1BsYXllci5kdXJhdGlvbiAqIGNsaWNrZWRQb3NpdGlvbiAvIGJhci53aWR0aCgpO1xyXG5cclxuICAgIHZpZGVvUGxheWVyLmN1cnJlbnRUaW1lID0gbmV3UGxheWJhY2tQb3NpdGlvblNlYztcclxuICB9KTtcclxuXHJcbiAgdmlkZW9QbGF5ZXIub250aW1ldXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgY29uc3QgZHVyYXRpb25TZWMgPSB2aWRlb1BsYXllci5kdXJhdGlvbjtcclxuICAgIGNvbnN0IGNvbXBsZXRlZFNlYyA9IHZpZGVvUGxheWVyLmN1cnJlbnRUaW1lO1xyXG4gICAgY29uc3QgY29tcGxldGVkUGVyY2VudCA9IChjb21wbGV0ZWRTZWMgLyBkdXJhdGlvblNlYykgKiAxMDA7XHJcblxyXG4gICAgJChcIi52aWRlb19fY3Vyc29yLWJ0blwiKS5jc3Moe1xyXG4gICAgICBsZWZ0OiBgJHtjb21wbGV0ZWRQZXJjZW50fSVgXHJcbiAgICB9KTtcclxuICB9O1xyXG5cclxuLy8g0KPQv9GA0LDQstC70LXQvdC40LUg0LPRgNC+0LzQutC+0YHRgtGM0Y4g0LfQstGD0LrQsFxyXG5cclxuICAkKFwiLnZpZGVvX192b2x1bWVcIikub24oXCJjbGlja1wiLCBlID0+IHtcclxuICAgIGNvbnN0IGJhciA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcclxuICAgIGNvbnN0IGNsaWNrZWRQb3NpdGlvbiA9IGUub3JpZ2luYWxFdmVudC5sYXllclg7XHJcblxyXG4gICAgdmlkZW9QbGF5ZXIudm9sdW1lID0gY2xpY2tlZFBvc2l0aW9uIC8gYmFyLndpZHRoKCk7XHJcbiAgfSk7XHJcblxyXG4gIHZpZGVvUGxheWVyLm9udm9sdW1lY2hhbmdlID0gKCkgPT4ge1xyXG4gICAgY29uc3QgY3VycmVudFZvbHVtZSA9IHZpZGVvUGxheWVyLnZvbHVtZTtcclxuICAgIGNvbnN0IG5ld0J1dHRvblBvc2l0aW9uUGVyY2VudCA9IGN1cnJlbnRWb2x1bWUgKiAxMDA7XHJcblxyXG4gICAgJChcIi52aWRlb19fdm9sdW1lLWJ1dHRvblwiKS5jc3Moe1xyXG4gICAgICBsZWZ0OiBgJHtuZXdCdXR0b25Qb3NpdGlvblBlcmNlbnR9JWBcclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG4vLyDQkdC10Lcg0LfQstGD0LrQsCBcclxuXHJcbiAgJCgnLmJ0bi12b2x1bWUnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgaWYgKHZpZGVvUGxheWVyLnZvbHVtZSA+IDApIHtcclxuICAgICAgICB2aWRlb1BsYXllci52b2x1bWUgPSAwO1xyXG4gICAgICAgICQoJy5idG4tdm9sdW1lX19saW5lJykuY3NzKCdkaXNwbGF5JywgJ2Jsb2NrJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHZpZGVvUGxheWVyLnZvbHVtZSA9IDE7XHJcbiAgICAgICAkKCcuYnRuLXZvbHVtZV9fbGluZScpLmNzcygnZGlzcGxheScsICdub25lJyk7XHJcbiAgfVxyXG59KTsiLCJjb25zdCBjdHJsTGlzdCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5yZXZpZXdzX19zd2l0Y2hlcicpO1xyXG5jb25zdCBjdHJsSXRlbXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuaW50ZXJhY3RpdmUtYXZhdGFyJyk7XHJcbmNvbnN0IHJldmlld0l0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnJldmlld3NfX2Rpc3BsYXktaW5uZXInKTtcclxuXHJcblxyXG5bXS5mb3JFYWNoLmNhbGwoY3RybEl0ZW1zLCAoZWwpID0+IHtcclxuICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcclxuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgbGV0IGN0cmxJdGVtID0gZS50YXJnZXQuY2xvc2VzdCgnbGknKTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjdHJsSXRlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgY3RybEl0ZW1zW2ldLmNsYXNzTGlzdC5yZW1vdmUoJ2ludGVyYWN0aXZlLWF2YXRhci0tYWN0aXZlJyk7XHJcbiAgICBcclxuICAgICAgICAgICAgaWYgKGN0cmxJdGVtc1tpXSA9PT0gY3RybEl0ZW0pIHtcclxuICAgICAgICAgICAgICAgIHJldmlld0l0ZW1zW2ldLmNsYXNzTGlzdC5hZGQoJ3Jldmlld3NfX2Rpc3BsYXktaW5uZXItLWFjdGl2ZScpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXZpZXdJdGVtc1tpXS5jbGFzc0xpc3QucmVtb3ZlKCdyZXZpZXdzX19kaXNwbGF5LWlubmVyLS1hY3RpdmUnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjdHJsSXRlbS5jbGFzc0xpc3QuYWRkKCdpbnRlcmFjdGl2ZS1hdmF0YXItLWFjdGl2ZScpO1xyXG5cclxuICAgIH0pXHJcbn0pOyIsImNvbnN0IHRlYW1JdGVtcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy50ZWFtX19pdGVtJyk7XHJcblxyXG5bXS5mb3JFYWNoLmNhbGwodGVhbUl0ZW1zLCBmdW5jdGlvbihlbCkge1xyXG4gICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpIHtcclxuXHJcbiAgICAgICAgaWYgKCFlbC5jbGFzc0xpc3QuY29udGFpbnMoJ3RlYW1fX2l0ZW0tLWFjdGl2ZScpKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVhbUl0ZW1zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0ZWFtSXRlbXNbaV0uY2xhc3NMaXN0LnJlbW92ZSgndGVhbV9faXRlbS0tYWN0aXZlJylcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbC5jbGFzc0xpc3QuYWRkKCd0ZWFtX19pdGVtLS1hY3RpdmUnKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKCd0ZWFtX19pdGVtLS1hY3RpdmUnKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufSk7Il19
